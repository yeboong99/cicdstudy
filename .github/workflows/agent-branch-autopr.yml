name: Agent Branch Docker CI + Auto PR

on:
  push:
    branches:
      - 'yeboong99/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: agent-branch-autopr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  verify-and-open-pr:
    if: github.ref_name != 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify with Docker + Gradle
        env:
          DB_USERNAME: root
          DB_PASSWORD: forcicd_local
        run: |
          set -Eeuo pipefail
          chmod +x gradlew
          docker compose -f docker-compose.yml up -d --build

          for i in $(seq 1 60); do
            response="$(curl -fsS 'http://localhost:8080/cal/add?firstNumber=1&secondNumber=2' || true)"
            if echo "$response" | grep -q '"result":"3"'; then
              echo "Smoke test passed"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "Smoke test failed"
              docker compose -f docker-compose.yml logs app --tail=120 || true
              exit 1
            fi
            sleep 2
          done

          ./gradlew clean test

      - name: Cleanup Docker
        if: always()
        env:
          DB_USERNAME: root
          DB_PASSWORD: forcicd_local
        run: docker compose -f docker-compose.yml down --remove-orphans -v

      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          set -Eeuo pipefail

          existing_pr="$(gh pr list \
            --repo "${REPO}" \
            --state open \
            --head "${BRANCH_NAME}" \
            --base main \
            --json number \
            --jq '.[0].number // empty')"

          if [ -n "${existing_pr}" ]; then
            echo "PR already exists: #${existing_pr}"
            exit 0
          fi

          title="[Auto] ${BRANCH_NAME#*/}"
          body_file="$(mktemp)"
          git fetch origin main --depth=1
          changed_files="$(git diff --name-only origin/main...HEAD || true)"

          {
            echo "## 작업 브랜치"
            echo
            echo "- 브랜치명: \`${BRANCH_NAME}\`"
            echo
            echo "## 변경 내용"
            echo
            if [ -n "${changed_files}" ]; then
              printf '%s\n' "${changed_files}" | sed 's/^/- /'
            else
              echo "- 자동 생성: 변경 파일 목록 조회 실패"
            fi
            echo
            echo "## 리뷰 요청 사항"
            echo
            echo "- 자동 생성 PR입니다. Docker 스모크 테스트와 \`./gradlew clean test\`를 통과했습니다."
          } > "${body_file}"

          gh pr create \
            --repo "${REPO}" \
            --base main \
            --head "${BRANCH_NAME}" \
            --title "${title}" \
            --body-file "${body_file}"

          rm -f "${body_file}"
